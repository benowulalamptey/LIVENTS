<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Livents Viewer</title> <!-- CHANGE TO Livents Viewer IN LIVENTS REPO -->
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #111;
      color: #fff;
      overflow-x: hidden;
    }

    /* --- Top Search Bar --- */
    #topBar {
      width: 100%;
      background: #222;
      padding: 10px;
      box-sizing: border-box;
      display: flex;
      justify-content: center;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    #searchInput {
      width: 90%;
      padding: 10px;
      font-size: 16px;
      border-radius: 6px;
      border: none;
    }

    /* --- Event List Container --- */
    #eventList {
      padding: 10px;
    }

    .eventCard {
      background: #1c1c1c;
      padding: 15px;
      margin-bottom: 12px;
      border-radius: 8px;
      cursor: pointer;
      border: 1px solid #333;
      transition: transform 0.2s ease;
    }

    .eventCard:hover {
      transform: scale(1.01);
      background: #262626;
    }

    .eventTitle {
      font-size: 18px;
      font-weight: bold;
      color: #ffcc66;
    }

    .eventTime {
      font-size: 14px;
      opacity: 0.8;
    }

    .eventSP {
      margin-top: 5px;
      font-size: 14px;
      color: #7fd0ff;
      font-style: italic;
    }

    /* --- Viewer Layout --- */
    #viewerContainer {
      width: 100%;
      height: 100vh;
      display: none;
      flex-direction: row;
      background: #000;
    }

    #p1 {
      width: 60%;
      height: 100%;
      background: #111;
    }

    #rightPane {
      width: 40%;
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    #p2, #p3 {
      width: 100%;
      height: 50%;
      background: #222;
    }

    video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      background: #000;
    }

    /* --- SP buttons --- */
    #spButtons {
      display: none;
      padding: 10px;
      background: #111;
      color: #fff;
      border-bottom: 1px solid #333;
    }

    .spBtn {
      padding: 8px 12px;
      margin-right: 10px;
      background: #333;
      border-radius: 6px;
      cursor: pointer;
      display: inline-block;
    }

    .spBtn:hover {
      background: #444;
    }

  </style>
</head>
<body>

  <!-- ðŸ” TOP SEARCH BAR -->
  <div id="topBar">
    <input id="searchInput" placeholder="Search events..." />
  </div>

  <!-- ðŸ“… EVENT LIST -->
  <div id="eventList"></div>

  <!-- ðŸŽ¥ VIEWER UI -->
  <div id="viewerContainer">
    <div id="p1"><video id="v1" autoplay playsinline></video></div>

    <div id="rightPane">
      <div id="p2"><video id="v2" autoplay playsinline></video></div>
      <div id="p3"><video id="v3" autoplay playsinline></video></div>
    </div>
  </div>

  <!-- â­ SP SELECTION BUTTONS -->
  <div id="spButtons">
    <span id="sp1Btn" class="spBtn"></span>
    <span id="sp2Btn" class="spBtn"></span>
  </div>

<script>
  const API = window.location.origin.includes("livents")
    ? "https://livents-backend.onrender.com"
    : "https://ludi-backend.onrender.com";

  let events = [];
  let selectedSP1 = false;
  let selectedSP2 = false;

  const eventList = document.getElementById("eventList");
  const searchInput = document.getElementById("searchInput");
  const viewerContainer = document.getElementById("viewerContainer");

  const spButtons = document.getElementById("spButtons");
  const sp1Btn = document.getElementById("sp1Btn");
  const sp2Btn = document.getElementById("sp2Btn");

  // -------------------------
  // LOAD EVENTS
  // -------------------------
  async function loadEvents() {
    const res = await fetch(`${API}/events`);
    events = await res.json();
    renderEvents(events);
  }

  function truncateText(txt) {
    if (!txt) return "";
    if (txt.length <= 80) return txt;
    return txt.substring(0, 80) + "...";
  }

  function renderEvents(list) {
    eventList.innerHTML = "";
    list.forEach(ev => {
      const div = document.createElement("div");
      div.className = "eventCard";

      let spInfo = "";
      if (ev.sp1Desc || ev.sp2Desc) {
        spInfo = `<div class='eventSP'>
          ${ev.sp1Desc ? "SP1: " + truncateText(ev.sp1Desc) : ""}
          ${ev.sp2Desc ? "<br>SP2: " + truncateText(ev.sp2Desc) : ""}
        </div>`;
      }

      div.innerHTML = `
        <div class="eventTitle">${ev.title}</div>
        <div class="eventTime">${ev.time}</div>
        ${spInfo}
      `;

      div.onclick = () => openViewer(ev);
      eventList.appendChild(div);
    });
  }

  // -------------------------
  // EVENT SEARCH
  // -------------------------
  searchInput.addEventListener("input", () => {
    const q = searchInput.value.toLowerCase();
    const filtered = events.filter(e =>
      e.title.toLowerCase().includes(q) ||
      (e.sp1Desc && e.sp1Desc.toLowerCase().includes(q)) ||
      (e.sp2Desc && e.sp2Desc.toLowerCase().includes(q))
    );
    renderEvents(filtered);
  });

  // -------------------------
  // OPEN VIEWER
  // -------------------------
  function openViewer(ev) {
    document.getElementById("eventList").style.display = "none";
    viewerContainer.style.display = "flex";

    selectedSP1 = false;
    selectedSP2 = false;

    if (ev.sp1Desc) {
      sp1Btn.style.display = "inline-block";
      sp1Btn.textContent = "Special Picture 1";
      spButtons.style.display = "block";
    } else {
      sp1Btn.style.display = "none";
    }

    if (ev.sp2Desc) {
      sp2Btn.style.display = "inline-block";
      sp2Btn.textContent = "Special Picture 2";
      spButtons.style.display = "block";
    } else {
      sp2Btn.style.display = "none";
    }

    // TODO: attach Mux/Livekit playback stream assignments here (v18)

    sp1Btn.onclick = () => toggleSP("sp1");
    sp2Btn.onclick = () => toggleSP("sp2");
  }

  function toggleSP(which) {
    if (which === "sp1") selectedSP1 = !selectedSP1;
    else selectedSP2 = !selectedSP2;

    updateLayout();
  }

  function updateLayout() {
    const v2 = document.getElementById("v2");
    const v3 = document.getElementById("v3");

    if (selectedSP1 && selectedSP2) {
      v2.textContent = "SP1 Stream";
      v3.textContent = "SP2 Stream";
    } else if (selectedSP1 && !selectedSP2) {
      v3.textContent = "SP1 Stream";
      v2.textContent = "P2 Stream";
    } else if (!selectedSP1 && selectedSP2) {
      v3.textContent = "SP2 Stream";
      v2.textContent = "P2 Stream";
    } else {
      v2.textContent = "P2 Stream";
      v3.textContent = "P3 Stream";
    }
  }

  loadEvents();
</script>
</body>
</html>
